# PDF Export Print 使用指南

基于 TypeSafeAdapterExample 示例的详细使用文档

## 📋 目录

- [1. 模块使用指南](#1-模块使用指南)
- [2. 数据配置指南](#2-数据配置指南)
- [3. 代码引用规范](#3-代码引用规范)
- [4. 常见问题与最佳实践](#4-常见问题与最佳实践)

---

## 1. 模块使用指南

### 1.1 可用模块类型

项目支持以下 6 种核心模块：

| 模块类型 | 枚举值 | 功能描述 | 默认优先级 |
|---------|--------|----------|-----------|
| **Logo模块** | `pdf.ModuleTypes.logo` | 显示公司Logo或图片 | 1 |
| **标题模块** | `pdf.ModuleTypes.title` | 显示文档标题 | 2 |
| **主表模块** | `pdf.ModuleTypes.mainTable` | 显示主要业务数据表格 | 3 |
| **子表模块** | `pdf.ModuleTypes.subTable` | 显示详细数据列表 | 4 |
| **审批模块** | `pdf.ModuleTypes.approval` | 显示审批记录 | 5 |
| **页脚模块** | `pdf.ModuleTypes.footer` | 显示页脚信息 | 6 |

### 1.2 模块初始化步骤

#### 步骤1：创建类型安全适配器

```dart
import 'package:pdf_export_print/pdf_export_print.dart' as pdf;

// 使用自定义配置初始化适配器
final adapter = pdf.TypeSafeDataAdapter(config: _createCustomConfig());

// 或使用默认配置（不推荐，字段标签将显示为原始键名）
// final adapter = pdf.TypeSafeDataAdapter();
```

#### 步骤2：创建PDF配置

```dart
final config = pdf.PDFConfig.builder()
    .withOrientation(pdf.PageOrientation.portrait)  // 页面方向
    .pageSize(pdf.PdfPageFormat.a4)                // 页面尺寸
    .margins(const pdf.EdgeInsets.all(20))         // 页边距
    .build();
```

#### 步骤3：构建PDF

```dart
final pdfBuilder = pdf.PDFPrintBuilder()
    .withConfig(config)
    .withDataAdapter(adapter);

// 根据配置添加启用的模块
_addModulesBasedOnConfig(pdfBuilder);

// 生成PDF文档
final pdfDocument = await pdfBuilder.build(businessData);
```

### 1.3 模块配置参数详解

每个模块通过 `pdf.AdapterModuleConfig` 进行配置：

```dart
pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.logo,        // 模块类型（必需）
  enabled: true,                           // 是否启用模块
  priority: 1,                             // 显示优先级（数值越小越靠前）
  required: false,                         // 数据验证时是否必需
  fieldConfigs: [...],                     // 字段配置列表
  customSettings: {...},                   // 自定义设置
)
```

**参数说明：**

- `enabled`: 控制模块是否参与PDF生成
- `priority`: 控制模块在PDF中的显示顺序，数值越小优先级越高
- `required`: 数据验证时是否必须提供该模块的数据
- `fieldConfigs`: 字段级别的配置，包括列宽百分比、排序等
- `customSettings`: 模块特定的自定义设置，如列宽配置

---

## 2. 数据配置指南

### 2.1 数据模型概述

项目现在使用专用的数据模型，提供类型安全和结构化的数据访问：

| 模块类型 | 数据模型 | 主要字段 | 特殊功能 |
|---------|----------|----------|----------|
| **Logo模块** | `LogoData` | logoUrl, width, height | 支持动态尺寸配置 |
| **标题模块** | `TitleData` | titles, color, alignment | 支持动态颜色和对齐 |
| **主表模块** | `MainTableData` | fields, showBorder, showInnerBorder | 统一的表格数据模型 |
| **页脚模块** | `MainTableData` | fields, fieldsPerRow, showBorder | 与主表共享数据模型 |
| **子表模块** | `SubTableData` | headers, rows, title, columnWidths | 结构化表格数据 |
| **审批模块** | `SubTableData` | headers, rows, title | 与子表共享数据模型 |

### 2.2 字段标签映射配置

在从接口获取数据后，首先需要配置字段标签映射：

```dart
pdf.DataAdapterConfig _createCustomConfig() {
  // 自定义字段标签映射
  final customFieldLabels = pdf.FieldLabelConfig.custom({
    // 主表字段
    'name': '员工姓名',
    'age': '年龄',
    'department': '所属部门',
    'position': '岗位职务',
    'email': '邮箱地址',
    'phone': '联系电话',
    'salary': '薪资',
    'description': '工作描述',
    
    // 页脚字段
    'preparedBy': '制单人',
    'checkedBy': '审核人',
    'approvedBy': '批准人',
    'printDate': '打印日期',
    'version': '版本号',
    'pageCount': '页数',
    
    // 审批字段
    'nodeName': '审批节点',
    'approver': '审批人',
    'signature': '签名',
    'approveTime': '审批时间',
    'opinion': '审批意见',
    
    // 子表字段
    'projectName': '项目名称',
    'startDate': '开始时间',
    'endDate': '结束时间',
    'status': '项目状态',
    'evaluation': '项目评价',
    
    // 模块标题
    'subTable': '项目详情',
    'approval': '审批记录',
  });
  
  return pdf.DataAdapterConfig(
    fieldLabelConfig: customFieldLabels,
    moduleConfigs: customModuleConfigs,
    dataKeyMappings: customDataKeyMappings,
  );
}
```

### 2.2 数据模型使用示例

#### 2.2.1 TitleData 使用示例

```dart
// 基础标题配置
final titleData = {
  'titles': ['员工信息表', '2024年度报告'],
};

// 高级标题配置（支持动态颜色和对齐）
final advancedTitleData = {
  'titles': ['重要通知', '紧急事项'],
  'color': 'red',           // 动态设置颜色
  'alignment': 'center',    // 动态设置对齐方式
};
```

#### 2.2.2 LogoData 使用示例

```dart
// 基础Logo配置
final logoData = {
  'logoUrl': 'https://example.com/logo.png',
};

// 高级Logo配置（支持动态尺寸）
final advancedLogoData = {
  'logoUrl': 'https://example.com/logo.png',
  'width': pw.LogoConstants.largeWidth,    // 使用常量
  'height': pw.LogoConstants.largeHeight,  // 使用常量
};
```

#### 2.2.3 MainTableData 使用示例

```dart
// 主表数据（自动使用 MainTableData.forMainTable）
final mainTableData = {
  'name': '张三',
  'department': '技术部',
  'position': '高级工程师',
  'email': 'zhangsan@example.com',
};

// 页脚数据（自动使用 MainTableData.forFooter）
final footerData = {
  'preparedBy': '张三',
  'checkedBy': '李四',
  'approvedBy': '王五',
  'printDate': '2024-01-15',
};
```

#### 2.2.4 SubTableData 使用示例

```dart
// 子表数据（自动转换为 SubTableData）
final subTableData = [
  {
    'projectName': '项目A',
    'status': '进行中',
    'startDate': '2024-01-01',
    'endDate': '2024-06-30',
  },
  {
    'projectName': '项目B',
    'status': '已完成',
    'startDate': '2023-07-01',
    'endDate': '2023-12-31',
  },
];
```

### 2.3 模块显示控制配置

通过 `enabled` 参数控制模块的显示/隐藏：

```dart
final customModuleConfigs = <pdf.ModuleTypes, pdf.AdapterModuleConfig>{
  // 启用Logo模块
  pdf.ModuleTypes.logo: const pdf.AdapterModuleConfig(
    moduleType: pdf.ModuleTypes.logo,
    enabled: true,                    // 显示Logo
    priority: 1,
    required: false,
  ),
  
  // 禁用子表模块
  pdf.ModuleTypes.subTable: const pdf.AdapterModuleConfig(
    moduleType: pdf.ModuleTypes.subTable,
    enabled: false,                   // 隐藏子表
    priority: 4,
    required: false,
  ),
  
  // 条件性启用审批模块
  pdf.ModuleTypes.approval: pdf.AdapterModuleConfig(
    moduleType: pdf.ModuleTypes.approval,
    enabled: hasApprovalData,         // 根据数据动态控制
    priority: 5,
    required: false,
  ),
};
```

### 2.3 列宽百分比配置

#### 2.3.1 子表模块列宽配置

```dart
pdf.ModuleTypes.subTable: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.subTable,
  enabled: true,
  priority: 4,
  required: false,
  customSettings: {
    'columnWidths': {
      'projectName': 0.4,    // 项目名称列占40%
      'status': 0.2,         // 状态列占20%
      'startDate': 0.2,      // 开始时间列占20%
      // 其他列自动分配剩余20%
    },
  },
),
```

#### 2.3.2 审批模块列宽配置

```dart
pdf.ModuleTypes.approval: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.approval,
  enabled: true,
  priority: 5,
  required: false,
  customSettings: {
    'columnWidths': {
      'nodeName': 0.25,      // 节点名称列占25%
      'approver': 0.20,      // 审批人列占20%
      'approveTime': 0.25,   // 审批时间列占25%
      // 其他列（签名、意见等）自动分配剩余30%
    },
  },
),
```

**列宽配置规则：**
- 使用小数表示百分比（0.4 = 40%）
- 配置的列宽总和应 ≤ 1.0
- 未配置的列将平均分配剩余宽度
- 如果总和超过1.0，系统会自动调整

### 2.4 子表列排序配置

子表模块支持通过字段排序权重来控制列的显示顺序，这对于动态调整表格布局非常有用。

#### 2.4.1 排序权重配置

```dart
// 在适配器中配置字段排序权重
final adapter = pdf.TypeSafeDataAdapter(config: adapterConfig);

// 创建子表数据时设置排序权重
final subTableData = adapter.createSubTableData(
  headers: ['projectName', 'status', 'startDate', 'endDate', 'evaluation'],
  rows: projectRows,
  moduleType: 'sub_table',
  includeHeaderSorts: true,  // 启用字段排序
);
```

#### 2.4.2 字段配置中的排序

通过 `FieldConfig` 的 `sort` 参数控制字段排序：

```dart
pdf.ModuleTypes.subTable: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.subTable,
  enabled: true,
  priority: 4,
  fieldConfigs: [
    pdf.FieldConfig(
      fieldKey: 'projectName',
      sort: 5,  // 最高优先级，显示在最前面
    ),
    pdf.FieldConfig(
      fieldKey: 'status',
      sort: 3,  // 中等优先级
    ),
    pdf.FieldConfig(
      fieldKey: 'startDate',
      sort: 2,  // 较低优先级
    ),
    pdf.FieldConfig(
      fieldKey: 'endDate',
      sort: 1,  // 最低优先级，显示在最后面
    ),
    // 未配置的字段使用默认排序权重 0
  ],
),
```

#### 2.4.3 排序规则说明

**排序权重规则：**
- 数值越大，优先级越高，显示越靠前
- 相同权重的字段保持原始顺序
- 未配置排序权重的字段默认为 0
- 支持负数权重，用于强制后置显示

**实际应用示例：**

```dart
// 业务场景：项目管理表格
// 希望按重要性排序：项目名称 > 状态 > 时间信息 > 其他
final fieldConfigs = [
  pdf.FieldConfig(fieldKey: 'projectName', sort: 10),  // 最重要
  pdf.FieldConfig(fieldKey: 'status', sort: 8),        // 次重要
  pdf.FieldConfig(fieldKey: 'startDate', sort: 5),     // 中等重要
  pdf.FieldConfig(fieldKey: 'endDate', sort: 4),       // 中等重要
  pdf.FieldConfig(fieldKey: 'evaluation', sort: 2),    // 较低重要
  pdf.FieldConfig(fieldKey: 'remark', sort: -1),       // 最后显示
];
```

#### 2.4.4 动态排序配置

```dart
// 根据用户偏好动态配置排序
Map<String, int> getUserPreferredSort() {
  return {
    'projectName': 10,
    'status': 8,
    'priority': 6,
    'startDate': 4,
    'endDate': 2,
  };
}

// 应用到字段配置
final userSorts = getUserPreferredSort();
final fieldConfigs = userSorts.entries.map((entry) {
  return pdf.FieldConfig(
    fieldKey: entry.key,
    sort: entry.value,
  );
}).toList();
```

### 2.5 字段配置详解

#### 2.5.1 主表字段配置

```dart
pdf.ModuleTypes.mainTable: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.mainTable,
  enabled: true,
  priority: 3,
  required: false,
  fieldConfigs: [
    pdf.FieldConfig(
      fieldKey: 'description',    // 字段键名
      widthPercent: 1.0,          // 列宽百分比（100%全宽）
      sort: 2,                    // 排序权重（数值越大越靠前）
    ),
    pdf.FieldConfig(
      fieldKey: 'name',
      widthPercent: 0.33,         // 列宽百分比（33%）
      sort: 3,
    ),
    pdf.FieldConfig(
      fieldKey: 'department',
      widthPercent: 0.33,         // 列宽百分比（33%）
      sort: 1,
    ),
  ],
),
```

#### 2.5.2 页脚字段配置

```dart
pdf.ModuleTypes.footer: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.footer,
  enabled: true,
  priority: 6,
  required: false,
  fieldConfigs: [
    pdf.FieldConfig(
      fieldKey: 'totalAmount',
      widthPercent: 0.67,         // 总金额占67%宽度
      sort: 1,
    ),
    pdf.FieldConfig(
      fieldKey: 'createDate',
      widthPercent: 0.33,         // 创建日期占33%宽度
      sort: 2,
    ),
  ],
),
```

**字段配置参数说明：**
- `fieldKey`: 对应数据中的字段键名
- `widthPercent`: 列宽百分比，0.0-1.0（如0.33表示33%）
- `sort`: 排序权重，数值越大显示越靠前
- `required`: 该字段是否必需（默认false）

### 2.6 数据源配置

#### 2.6.1 数据键映射

```dart
final customDataKeyMappings = <pdf.DataKeys, pdf.ModuleTypes>{
  pdf.DataKeys.logoUrl: pdf.ModuleTypes.logo,
  pdf.DataKeys.titles: pdf.ModuleTypes.title,
  pdf.DataKeys.mainData: pdf.ModuleTypes.mainTable,
  pdf.DataKeys.details: pdf.ModuleTypes.subTable,
  pdf.DataKeys.approvals: pdf.ModuleTypes.approval,
  pdf.DataKeys.footerData: pdf.ModuleTypes.footer,
};
```

#### 2.6.2 业务数据结构

```dart
Map<String, dynamic> createBusinessData() {
  return {
    // 使用DataKeys枚举确保类型安全
    pdf.DataKeys.titles.value: ['员工信息表', '人事档案'],
    
    pdf.DataKeys.logoUrl.value: 'https://example.com/logo.png',
    
    pdf.DataKeys.mainData.value: {
      'name': '张三',
      'age': 28,
      'department': '技术部',
      'position': '高级工程师',
      'email': 'zhangsan@example.com',
      'phone': '13800138000',
      'salary': 15000,
      'description': '负责核心业务系统开发和维护',
    },
    
    pdf.DataKeys.details.value: [
      {
        'projectName': 'PDF导出系统',
        'startDate': '2024-01-01',
        'endDate': '2024-03-31',
        'status': '已完成',
        'evaluation': '优秀',
      },
      // 更多子表数据...
    ],
    
    pdf.DataKeys.approvals.value: [
      {
        'nodeName': '申请',
        'approver': '李四',
        'signature': '李四',
        'approveTime': '2024-01-15 09:30:00',
        'opinion': '申请提交',
      },
      // 更多审批记录...
    ],
    
    pdf.DataKeys.footerData.value: {
      'preparedBy': '张三',
      'checkedBy': '李四',
      'approvedBy': '王五',
      'printDate': '2024-01-16',
      'version': 'v2.0',
      'pageCount': '1/1',
    },
  };
}
```

---

## 3. 常量管理指南

### 3.1 可用常量类

项目提供了统一的常量管理，避免硬编码数值：

| 常量类 | 用途 | 主要常量 |
|--------|------|----------|
| `pw.LogoConstants` | Logo模块 | defaultWidth, defaultHeight, smallWidth, largeWidth |
| `pw.TitleConstants` | 标题模块 | defaultColor, defaultAlignment, defaultSpacing |
| `pw.TableConstants` | 表格模块 | defaultCellPadding, defaultHeaderHeight, defaultRowHeight |
| `pw.LayoutConstants` | 布局通用 | defaultMargin, defaultFontSize, titleFontSize |

### 3.2 常量使用示例

#### 3.2.1 Logo常量使用

```dart
// 使用Logo常量
final logoData = {
  'logoUrl': 'https://example.com/logo.png',
  'width': pw.LogoConstants.defaultWidth,    // 120.0
  'height': pw.LogoConstants.defaultHeight,  // 60.0
};

// 不同尺寸的Logo
final smallLogo = {
  'logoUrl': 'https://example.com/small-logo.png',
  'width': pw.LogoConstants.smallWidth,      // 50.0
  'height': pw.LogoConstants.smallHeight,    // 50.0
};

final largeLogo = {
  'logoUrl': 'https://example.com/large-logo.png',
  'width': pw.LogoConstants.largeWidth,      // 150.0
  'height': pw.LogoConstants.largeHeight,    // 75.0
};
```

#### 3.2.2 表格常量使用

```dart
// 在配置中使用表格常量
pdf.ModuleTypes.subTable: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.subTable,
  enabled: true,
  priority: 4,
  customSettings: {
    'cellPadding': pw.TableConstants.defaultCellPadding,      // 4.0
    'headerHeight': pw.TableConstants.defaultHeaderHeight,    // 25.0
    'rowHeight': pw.TableConstants.defaultRowHeight,          // 20.0
    'reservedHeight': pw.TableConstants.defaultReservedHeight, // 100.0
  },
),
```

#### 3.2.3 布局常量使用

```dart
// 在PDF配置中使用布局常量
final config = pdf.PDFConfig.builder()
    .withOrientation(pdf.PageOrientation.portrait)
    .pageSize(pdf.PdfPageFormat.a4)
    .margins(pdf.EdgeInsets.all(pw.LayoutConstants.defaultMargin))  // 16.0
    .build();
```

### 3.3 常量的优势

- **一致性**：所有模块使用相同的默认值
- **可维护性**：修改常量值即可全局更新
- **类型安全**：编译时检查，避免错误
- **可读性**：语义化的常量名称，代码更易理解

---

## 4. 代码引用规范

### 3.1 导入规范

**✅ 正确的导入方式：**

```dart
import 'package:pdf_export_print/pdf_export_print.dart' as pdf;
```

**❌ 错误的导入方式：**

```dart
// 不要添加额外的PDF包导入
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
```

### 3.2 使用规范

**✅ 正确的使用方式：**

```dart
// 使用pdf前缀访问所有组件
final adapter = pdf.TypeSafeDataAdapter(config: config);
final pdfBuilder = pdf.PDFPrintBuilder();
final moduleConfig = pdf.AdapterModuleConfig(...);
final dataKeys = pdf.DataKeys.titles.value;
```

**❌ 错误的使用方式：**

```dart
// 不要直接使用类名
final adapter = TypeSafeDataAdapter(config: config);
final pdfBuilder = PDFPrintBuilder();
```

### 3.3 枚举使用规范

**✅ 推荐的枚举使用：**

```dart
// 使用枚举值确保类型安全
final moduleType = pdf.ModuleTypes.logo;
final dataKey = pdf.DataKeys.titles.value;

// 在数据中使用枚举值
final data = {
  pdf.DataKeys.titles.value: ['标题1', '标题2'],
  pdf.DataKeys.mainData.value: {...},
};
```

**❌ 不推荐的硬编码：**

```dart
// 避免硬编码字符串
final data = {
  'titles': ['标题1', '标题2'],  // 容易出错
  'mainData': {...},
};
```

---

## 5. 架构说明

### 5.1 简化后的架构

项目采用了简化的数据处理架构，提供更好的类型安全和性能：

```
原始数据 → TypeSafeDataAdapter → 专用数据模型 → 模块渲染
   ↓              ↓                    ↓           ↓
接口数据      数据转换和验证        TitleData     TitleModule
Map格式      兼容性处理           LogoData      LogoModule
           类型安全保证         MainTableData  MainTableModule
                              SubTableData   SubTableModule
```

### 5.2 模块职责分离

| 组件 | 职责 | 特点 |
|------|------|------|
| **TypeSafeDataAdapter** | 数据转换和兼容性处理 | 统一的数据入口，类型转换 |
| **专用数据模型** | 结构化数据存储 | 类型安全，字段明确 |
| **PDF模块** | 专注渲染逻辑 | 简洁的实现，直接使用数据模型 |

### 5.3 类型安全保证

```dart
// 模块内部直接使用专用数据模型
@override
Future<List<pw.Widget>> render(ModuleData data, PDFContext context) async {
  // 直接类型转换，适配器保证类型正确
  final titleData = data as TitleData;

  // 类型安全的属性访问
  if (titleData.titles.isEmpty) return [];

  // 直接使用结构化数据
  for (final title in titleData.titles) {
    // 渲染逻辑...
  }
}
```

### 5.4 配置优先级

数据配置遵循以下优先级规则：

1. **数据模型字段** > 模块配置 > 主题默认值
2. **FieldConfig配置** > customSettings配置
3. **用户传入数据** > 适配器默认值

```dart
// 示例：标题颜色的优先级
final color = titleData.color ??           // 1. 数据中的颜色
              _config.color ??              // 2. 配置中的颜色
              context.theme.titleColor;     // 3. 主题默认颜色
```

### 5.5 性能优化

- **编译时类型检查**：减少运行时错误
- **直接数据访问**：避免动态查找和转换
- **常量管理**：减少重复计算和内存占用
- **专用数据模型**：优化内存布局和访问速度

---

## 6. 常见问题与最佳实践

### 4.1 常见问题

#### Q1: 字段标签显示为原始键名？
**A:** 需要在 `FieldLabelConfig.custom()` 中配置字段映射：

```dart
final fieldLabels = pdf.FieldLabelConfig.custom({
  'name': '员工姓名',  // 将'name'映射为'员工姓名'
  'department': '所属部门',
});
```

#### Q2: 模块不显示？
**A:** 检查以下配置：
1. `enabled: true` - 模块是否启用
2. 数据是否正确提供
3. `dataKeyMappings` 是否正确配置

#### Q3: 列宽配置不生效？
**A:** 确保：
1. 配置在 `customSettings` 的 `columnWidths` 中
2. 字段名与数据中的键名一致
3. 百分比总和不超过1.0

#### Q4: 数据验证失败？
**A:** 检查：
1. 必需模块的 `required: true` 是否有对应数据
2. 数据键名是否使用 `pdf.DataKeys.xxx.value`
3. 数据结构是否符合预期格式

### 6.2 最佳实践

#### 6.2.1 数据模型使用建议

**✅ 推荐做法：**

```dart
// 使用结构化数据配置
final titleData = {
  'titles': ['主标题', '副标题'],
  'color': 'blue',
  'alignment': 'center',
};

// 使用常量替代硬编码
final logoData = {
  'logoUrl': 'https://example.com/logo.png',
  'width': pw.LogoConstants.defaultWidth,
  'height': pw.LogoConstants.defaultHeight,
};
```

**❌ 避免做法：**

```dart
// 避免硬编码数值
final logoData = {
  'logoUrl': 'https://example.com/logo.png',
  'width': 120.0,  // 应使用常量
  'height': 60.0,  // 应使用常量
};

// 避免不完整的配置
final titleData = ['标题'];  // 应使用Map格式支持更多配置
```

#### 6.2.2 配置优先级管理

```dart
// 利用配置优先级实现灵活控制
final titleData = {
  'titles': ['重要通知'],
  'color': 'red',        // 数据级别的颜色设置
  'alignment': 'center', // 数据级别的对齐设置
};

// 配置级别的默认设置
pdf.ModuleTypes.title: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.title,
  enabled: true,
  priority: 2,
  customSettings: {
    'color': 'blue',      // 配置级别的默认颜色
    'fontSize': 18.0,     // 配置级别的字体大小
  },
),
```

#### 6.2.3 配置管理

```dart
class PDFConfigManager {
  static pdf.DataAdapterConfig createConfig({
    required Map<String, String> fieldLabels,
    required Map<pdf.ModuleTypes, bool> moduleVisibility,
    Map<String, Map<String, double>>? columnWidths,
  }) {
    final moduleConfigs = <pdf.ModuleTypes, pdf.AdapterModuleConfig>{};
    
    for (final moduleType in pdf.ModuleTypes.values) {
      final isEnabled = moduleVisibility[moduleType] ?? true;
      final settings = <String, dynamic>{};
      
      // 添加列宽配置
      if (columnWidths?.containsKey(moduleType.value) == true) {
        settings['columnWidths'] = columnWidths![moduleType.value];
      }
      
      moduleConfigs[moduleType] = pdf.AdapterModuleConfig(
        moduleType: moduleType,
        enabled: isEnabled,
        priority: _getDefaultPriority(moduleType),
        customSettings: settings,
      );
    }
    
    return pdf.DataAdapterConfig(
      fieldLabelConfig: pdf.FieldLabelConfig.custom(fieldLabels),
      moduleConfigs: moduleConfigs,
      dataKeyMappings: pdf.DataAdapterConfig.defaultConfig().dataKeyMappings,
    );
  }
  
  static int _getDefaultPriority(pdf.ModuleTypes moduleType) {
    switch (moduleType) {
      case pdf.ModuleTypes.logo: return 1;
      case pdf.ModuleTypes.title: return 2;
      case pdf.ModuleTypes.mainTable: return 3;
      case pdf.ModuleTypes.subTable: return 4;
      case pdf.ModuleTypes.approval: return 5;
      case pdf.ModuleTypes.footer: return 6;
    }
  }
}
```

#### 4.2.2 数据验证

```dart
bool validateBusinessData(Map<String, dynamic> data) {
  // 检查必需的数据键
  final requiredKeys = [
    pdf.DataKeys.titles.value,
    pdf.DataKeys.mainData.value,
  ];
  
  for (final key in requiredKeys) {
    if (!data.containsKey(key) || data[key] == null) {
      print('缺少必需数据: $key');
      return false;
    }
  }
  
  // 检查数据类型
  if (data[pdf.DataKeys.titles.value] is! List) {
    print('titles数据类型错误，应为List');
    return false;
  }
  
  if (data[pdf.DataKeys.mainData.value] is! Map) {
    print('mainData数据类型错误，应为Map');
    return false;
  }
  
  return true;
}
```

#### 4.2.3 错误处理

```dart
Future<void> generatePDFSafely(Map<String, dynamic> data) async {
  try {
    // 数据验证
    if (!validateBusinessData(data)) {
      throw Exception('业务数据验证失败');
    }
    
    // 适配器验证
    if (!adapter.validateData(data)) {
      throw Exception('适配器数据验证失败');
    }
    
    // 生成PDF
    final pdfDocument = await pdfBuilder.build(data);
    
    // 处理成功结果
    await showPDFPreview(pdfDocument);
    
  } catch (e) {
    // 错误处理
    print('PDF生成失败: $e');
    showErrorDialog('PDF生成失败：${e.toString()}');
  }
}
```

### 4.3 性能优化建议

1. **配置缓存**: 将适配器配置缓存，避免重复创建
2. **数据预处理**: 在UI线程外预处理数据
3. **模块按需加载**: 根据业务需要动态启用模块
4. **内存管理**: 及时释放大型PDF文档对象

### 4.4 调试技巧

1. **启用详细日志**: 在开发环境启用详细的调试信息
2. **数据检查**: 使用 `adapter.validateData()` 验证数据
3. **模块检查**: 使用 `adapter.getSupportedModules()` 查看支持的模块
4. **配置检查**: 打印配置信息确认设置正确

### 4.5 水印配置

#### 4.5.1 文本水印配置

```dart
final pdfConfig = pdf.PDFConfig.builder()
    .withOrientation(pdf.PageOrientation.portrait)
    .watermark(pdf.WatermarkConfig.textWatermark(
      enabled: true,
      content: '机密文件',              // 水印文本
      position: pdf.WatermarkPosition.center,  // 水印位置
      mode: pdf.WatermarkMode.background,      // 水印模式
      opacity: 0.3,                           // 透明度(0.0-1.0)
      rotation: 0.785,                        // 旋转角度(弧度)
      fontSize: 48.0,                         // 字体大小
      textColor: pdf.PdfColors.grey,          // 文本颜色
      fontWeight: pdf.FontWeight.bold,        // 字体权重
    ))
    .build();
```

#### 4.5.2 图片水印配置

```dart
final imageData = await loadImageData('assets/watermark.png');

final pdfConfig = pdf.PDFConfig.builder()
    .watermark(pdf.WatermarkConfig.imageWatermark(
      enabled: true,
      imageData: imageData,                   // 图片数据
      position: pdf.WatermarkPosition.topRight,
      mode: pdf.WatermarkMode.foreground,
      opacity: 0.5,
      rotation: 0.0,
    ))
    .build();
```

#### 4.5.3 水印位置选项

```dart
// 九宫格位置选项
pdf.WatermarkPosition.topLeft      // 左上角
pdf.WatermarkPosition.topCenter    // 上中
pdf.WatermarkPosition.topRight     // 右上角
pdf.WatermarkPosition.centerLeft   // 左中
pdf.WatermarkPosition.center       // 中心
pdf.WatermarkPosition.centerRight  // 右中
pdf.WatermarkPosition.bottomLeft   // 左下角
pdf.WatermarkPosition.bottomCenter // 下中
pdf.WatermarkPosition.bottomRight  // 右下角
```

### 4.6 高级自定义配置

#### 4.6.1 自定义样式主题

```dart
final customTheme = pdf.CorporateTheme(pdf.PdfColors.blue);

final pdfConfig = pdf.PDFConfig.builder()
    .theme(customTheme)                     // 应用企业主题
    .pageSize(pdf.PdfPageFormat.a4)         // A4页面
    .margins(const pdf.EdgeInsets.all(20))  // 20pt边距
    .build();
```

#### 4.6.2 模块特定配置

```dart
// Logo模块自定义设置
pdf.ModuleTypes.logo: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.logo,
  enabled: true,
  priority: 1,
  customSettings: {
    'defaultWidth': 150.0,    // 默认宽度
    'defaultHeight': 75.0,    // 默认高度
    'alignment': 'center',    // 对齐方式
  },
),

// 标题模块自定义设置
pdf.ModuleTypes.title: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.title,
  enabled: true,
  priority: 2,
  customSettings: {
    'fontSize': 18.0,         // 字体大小
    'color': 'blue',          // 字体颜色
    'fontWeight': 'bold',     // 字体权重
    'alignment': 'center',    // 对齐方式
    'spacing': 10.0,          // 间距
  },
),
```

#### 4.6.3 表格样式自定义

```dart
// 主表模块样式配置
pdf.ModuleTypes.mainTable: const pdf.AdapterModuleConfig(
  moduleType: pdf.ModuleTypes.mainTable,
  enabled: true,
  priority: 3,
  customSettings: {
    'showBorder': true,           // 显示边框
    'borderColor': 'black',       // 边框颜色
    'borderWidth': 1.0,           // 边框宽度
    'cellPadding': 8.0,           // 单元格内边距
    'headerHeight': 30.0,         // 表头高度
    'rowHeight': 25.0,            // 行高
    'headerFontSize': 12.0,       // 表头字体大小
    'dataFontSize': 10.0,         // 数据字体大小
    'headerBackgroundColor': 'lightGrey',  // 表头背景色
  },
),
```

---

## 7. 完整示例代码

### 7.1 完整的配置示例

```dart
import 'package:flutter/material.dart';
import 'package:pdf_export_print/pdf_export_print.dart' as pdf;

class PDFExportService {
  late pdf.TypeSafeDataAdapter _adapter;
  late pdf.PDFConfig _config;

  /// 初始化PDF服务
  void initialize() {
    _adapter = pdf.TypeSafeDataAdapter(config: _createAdapterConfig());
    _config = _createPDFConfig();
  }

  /// 创建适配器配置
  pdf.DataAdapterConfig _createAdapterConfig() {
    // 字段标签映射
    final fieldLabels = pdf.FieldLabelConfig.custom({
      // 主表字段
      'employeeId': '员工编号',
      'name': '员工姓名',
      'department': '所属部门',
      'position': '岗位职务',
      'hireDate': '入职日期',
      'salary': '薪资',
      'email': '邮箱地址',
      'phone': '联系电话',
      'address': '家庭住址',
      'description': '工作描述',

      // 子表字段
      'projectName': '项目名称',
      'startDate': '开始时间',
      'endDate': '结束时间',
      'status': '项目状态',
      'role': '担任角色',
      'evaluation': '项目评价',
      'workload': '工作量',

      // 审批字段
      'stepName': '审批步骤',
      'approver': '审批人',
      'approveTime': '审批时间',
      'result': '审批结果',
      'opinion': '审批意见',
      'signature': '电子签名',

      // 页脚字段
      'preparedBy': '制单人',
      'checkedBy': '审核人',
      'approvedBy': '批准人',
      'printDate': '打印日期',
      'version': '版本号',
      'totalAmount': '总金额',
      'remark': '备注',
    });

    // 模块配置
    final moduleConfigs = <pdf.ModuleTypes, pdf.AdapterModuleConfig>{
      pdf.ModuleTypes.logo: const pdf.AdapterModuleConfig(
        moduleType: pdf.ModuleTypes.logo,
        enabled: true,
        priority: 1,
        required: false,
        customSettings: {
          'defaultWidth': 120.0,
          'defaultHeight': 60.0,
          'alignment': 'left',
        },
      ),

      pdf.ModuleTypes.title: const pdf.AdapterModuleConfig(
        moduleType: pdf.ModuleTypes.title,
        enabled: true,
        priority: 2,
        required: true,
        customSettings: {
          'fontSize': 20.0,
          'color': 'darkBlue',
          'fontWeight': 'bold',
          'alignment': 'center',
          'spacing': 15.0,
        },
      ),

      pdf.ModuleTypes.mainTable: const pdf.AdapterModuleConfig(
        moduleType: pdf.ModuleTypes.mainTable,
        enabled: true,
        priority: 3,
        required: false,
        fieldConfigs: [
          pdf.FieldConfig(fieldKey: 'description', widthPercent: 1.0, sort: 1),
          pdf.FieldConfig(fieldKey: 'name', widthPercent: 0.33, sort: 5),
          pdf.FieldConfig(fieldKey: 'employeeId', widthPercent: 0.33, sort: 6),
          pdf.FieldConfig(fieldKey: 'department', widthPercent: 0.33, sort: 4),
          pdf.FieldConfig(fieldKey: 'position', widthPercent: 0.33, sort: 3),
          pdf.FieldConfig(fieldKey: 'hireDate', widthPercent: 0.33, sort: 2),
        ],
        customSettings: {
          'showBorder': true,
          'fieldsPerRow': 3,
          'cellHeight': 28.0,
        },
      ),

      pdf.ModuleTypes.subTable: const pdf.AdapterModuleConfig(
        moduleType: pdf.ModuleTypes.subTable,
        enabled: true,
        priority: 4,
        required: false,
        customSettings: {
          'columnWidths': {
            'projectName': 0.25,    // 项目名称 25%
            'role': 0.15,           // 担任角色 15%
            'startDate': 0.15,      // 开始时间 15%
            'endDate': 0.15,        // 结束时间 15%
            'status': 0.15,         // 项目状态 15%
            'evaluation': 0.15,     // 项目评价 15%
            // workload 自动分配剩余空间
          },
          'showTitle': true,
          'titleText': '项目经历',
        },
      ),

      pdf.ModuleTypes.approval: const pdf.AdapterModuleConfig(
        moduleType: pdf.ModuleTypes.approval,
        enabled: true,
        priority: 5,
        required: false,
        customSettings: {
          'columnWidths': {
            'stepName': 0.20,       // 审批步骤 20%
            'approver': 0.15,       // 审批人 15%
            'approveTime': 0.20,    // 审批时间 20%
            'result': 0.15,         // 审批结果 15%
            'opinion': 0.30,        // 审批意见 30%
            // signature 自动分配剩余空间
          },
          'showTitle': true,
          'titleText': '审批记录',
        },
      ),

      pdf.ModuleTypes.footer: const pdf.AdapterModuleConfig(
        moduleType: pdf.ModuleTypes.footer,
        enabled: true,
        priority: 6,
        required: false,
        fieldConfigs: [
          pdf.FieldConfig(fieldKey: 'remark', widthPercent: 1.0, sort: 1),
          pdf.FieldConfig(fieldKey: 'totalAmount', widthPercent: 0.67, sort: 2),
          pdf.FieldConfig(fieldKey: 'preparedBy', widthPercent: 0.33, sort: 3),
          pdf.FieldConfig(fieldKey: 'checkedBy', widthPercent: 0.33, sort: 4),
          pdf.FieldConfig(fieldKey: 'approvedBy', widthPercent: 0.33, sort: 5),
        ],
        customSettings: {
          'fieldsPerRow': 3,
          'showBorder': true,
        },
      ),
    };

    // 数据键映射
    final dataKeyMappings = <pdf.DataKeys, pdf.ModuleTypes>{
      pdf.DataKeys.logoUrl: pdf.ModuleTypes.logo,
      pdf.DataKeys.titles: pdf.ModuleTypes.title,
      pdf.DataKeys.mainData: pdf.ModuleTypes.mainTable,
      pdf.DataKeys.details: pdf.ModuleTypes.subTable,
      pdf.DataKeys.approvals: pdf.ModuleTypes.approval,
      pdf.DataKeys.footerData: pdf.ModuleTypes.footer,
    };

    return pdf.DataAdapterConfig(
      fieldLabelConfig: fieldLabels,
      moduleConfigs: moduleConfigs,
      dataKeyMappings: dataKeyMappings,
    );
  }

  /// 创建PDF配置
  pdf.PDFConfig _createPDFConfig() {
    return pdf.PDFConfig.builder()
        .withOrientation(pdf.PageOrientation.portrait)
        .pageSize(pdf.PdfPageFormat.a4)
        .margins(const pdf.EdgeInsets.all(20))
        .watermark(pdf.WatermarkConfig.textWatermark(
          enabled: true,
          content: '内部资料',
          position: pdf.WatermarkPosition.center,
          opacity: 0.1,
          rotation: 0.785,
          fontSize: 60.0,
        ))
        .build();
  }

  /// 生成PDF
  Future<pdf.Document> generateEmployeePDF(Map<String, dynamic> employeeData) async {
    // 数据验证
    if (!_adapter.validateData(employeeData)) {
      throw Exception('员工数据验证失败');
    }

    // 创建PDF构建器
    final pdfBuilder = pdf.PDFPrintBuilder()
        .withConfig(_config)
        .withDataAdapter(_adapter);

    // 添加模块
    _addEnabledModules(pdfBuilder);

    // 生成PDF
    return await pdfBuilder.build(employeeData);
  }

  /// 添加启用的模块
  void _addEnabledModules(pdf.PDFPrintBuilder builder) {
    final moduleConfigs = _adapter.config.moduleConfigs;
    final sortedModules = moduleConfigs.entries.toList()
      ..sort((a, b) => a.value.priority.compareTo(b.value.priority));

    for (final entry in sortedModules) {
      if (!entry.value.enabled) continue;

      switch (entry.key) {
        case pdf.ModuleTypes.logo:
          builder.addModule(pdf.LogoModule());
          break;
        case pdf.ModuleTypes.title:
          builder.addModule(pdf.TitleModule());
          break;
        case pdf.ModuleTypes.mainTable:
          builder.addModule(pdf.MainTableModule());
          break;
        case pdf.ModuleTypes.subTable:
          builder.addModule(pdf.SubTableModule());
          break;
        case pdf.ModuleTypes.approval:
          builder.addModule(pdf.SubTableModule(
            moduleId: 'approval',
            config: _createApprovalConfig(),
          ));
          break;
        case pdf.ModuleTypes.footer:
          builder.addModule(pdf.FooterModule());
          break;
      }
    }
  }

  /// 创建审批模块配置
  pdf.SubTableConfig _createApprovalConfig() {
    return pdf.SubTableConfig(
      showBorder: true,
      headerAlignment: pdf.Alignment.center,
      dataAlignment: pdf.Alignment.centerLeft,
      showTitle: true,
      titleAlignment: pdf.Alignment.centerLeft,
      defaultColumnWidths: pdf.SubTableConfig.approvalDefaultColumnWidths,
    );
  }
}
```

### 5.2 使用示例

```dart
class EmployeePDFPage extends StatefulWidget {
  @override
  _EmployeePDFPageState createState() => _EmployeePDFPageState();
}

class _EmployeePDFPageState extends State<EmployeePDFPage> {
  final PDFExportService _pdfService = PDFExportService();

  @override
  void initState() {
    super.initState();
    _pdfService.initialize();
  }

  /// 生成并预览PDF
  Future<void> _generateAndPreviewPDF() async {
    try {
      // 模拟从API获取的员工数据
      final employeeData = await _fetchEmployeeData();

      // 生成PDF
      final pdfDocument = await _pdfService.generateEmployeePDF(employeeData);

      // 显示预览
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => pdf.PdfPreview(
            build: (format) => pdfDocument.save(),
            allowPrinting: true,
            allowSharing: true,
            canChangePageFormat: false,
          ),
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('PDF生成失败：$e')),
      );
    }
  }

  /// 模拟获取员工数据
  Future<Map<String, dynamic>> _fetchEmployeeData() async {
    // 模拟API调用延迟
    await Future.delayed(Duration(milliseconds: 500));

    return {
      pdf.DataKeys.titles.value: ['员工档案', '人事信息表'],

      pdf.DataKeys.logoUrl.value: 'https://example.com/company-logo.png',

      pdf.DataKeys.mainData.value: {
        'employeeId': 'EMP001',
        'name': '张三',
        'department': '技术研发部',
        'position': '高级软件工程师',
        'hireDate': '2022-03-15',
        'salary': 18000,
        'email': 'zhangsan@company.com',
        'phone': '13800138000',
        'address': '北京市朝阳区xxx街道xxx号',
        'description': '负责核心业务系统的架构设计和开发工作，具有丰富的全栈开发经验。',
      },

      pdf.DataKeys.details.value: [
        {
          'projectName': 'PDF导出系统',
          'role': '技术负责人',
          'startDate': '2023-01-01',
          'endDate': '2023-06-30',
          'status': '已完成',
          'evaluation': '优秀',
          'workload': '100%',
        },
        {
          'projectName': '用户管理平台',
          'role': '后端开发',
          'startDate': '2023-07-01',
          'endDate': '2023-12-31',
          'status': '进行中',
          'evaluation': '良好',
          'workload': '80%',
        },
      ],

      pdf.DataKeys.approvals.value: [
        {
          'stepName': '部门审批',
          'approver': '李四',
          'approveTime': '2024-01-15 10:30:00',
          'result': '通过',
          'opinion': '员工表现优秀，同意晋升申请',
          'signature': '李四',
        },
        {
          'stepName': 'HR审批',
          'approver': '王五',
          'approveTime': '2024-01-16 14:20:00',
          'result': '通过',
          'opinion': '符合晋升条件，予以批准',
          'signature': '王五',
        },
      ],

      pdf.DataKeys.footerData.value: {
        'preparedBy': '张三',
        'checkedBy': '李四',
        'approvedBy': '王五',
        'printDate': DateTime.now().toString().substring(0, 10),
        'version': 'v1.0',
        'totalAmount': '18000元',
        'remark': '此档案仅供内部使用，请妥善保管。',
      },
    };
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('员工PDF导出'),
        backgroundColor: Colors.blue,
        foregroundColor: Colors.white,
      ),
      body: Center(
        child: ElevatedButton(
          onPressed: _generateAndPreviewPDF,
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.blue,
            foregroundColor: Colors.white,
            padding: EdgeInsets.symmetric(horizontal: 32, vertical: 16),
          ),
          child: Text('生成员工PDF', style: TextStyle(fontSize: 16)),
        ),
      ),
    );
  }
}
```

### 7.2 新架构数据示例

#### 7.2.1 使用新数据模型的完整示例

```dart
// 使用新数据模型的员工数据
final employeeData = {
  // Logo数据 - 使用LogoData模型
  'logoUrl': {
    'logoUrl': 'https://company.com/logo.png',
    'width': pw.LogoConstants.defaultWidth,
    'height': pw.LogoConstants.defaultHeight,
  },

  // 标题数据 - 使用TitleData模型
  'titles': {
    'titles': ['员工信息表', '2024年度报告'],
    'color': 'blue',
    'alignment': 'center',
  },

  // 主表数据 - 使用MainTableData模型
  'mainData': {
    'name': '张三',
    'employeeId': 'EMP001',
    'department': '技术部',
    'position': '高级工程师',
    'email': 'zhangsan@company.com',
    'phone': '138-0000-0000',
    'hireDate': '2020-01-15',
    'description': '负责核心系统开发和技术架构设计，具有丰富的项目经验。',
  },

  // 子表数据 - 使用SubTableData模型
  'details': [
    {
      'projectName': '电商平台重构',
      'status': '已完成',
      'startDate': '2023-01-01',
      'endDate': '2023-06-30',
      'evaluation': '优秀',
      'workload': '100%',
    },
    {
      'projectName': '移动端APP开发',
      'status': '进行中',
      'startDate': '2023-07-01',
      'endDate': '2024-03-31',
      'evaluation': '良好',
      'workload': '80%',
    },
  ],

  // 页脚数据 - 使用MainTableData模型
  'footerData': {
    'preparedBy': '张三',
    'checkedBy': '李四',
    'approvedBy': '王五',
    'printDate': '2024-01-15',
    'version': 'v1.0',
    'remark': '此报告仅供内部使用',
    'totalAmount': '年度绩效奖金：50000元',
  },
};
```

#### 7.2.2 常量使用最佳实践

```dart
// ✅ 推荐：使用常量
final logoConfig = {
  'logoUrl': 'https://company.com/logo.png',
  'width': pw.LogoConstants.largeWidth,     // 150.0
  'height': pw.LogoConstants.largeHeight,   // 75.0
};

// ❌ 避免：硬编码数值
final logoConfig = {
  'logoUrl': 'https://company.com/logo.png',
  'width': 150.0,  // 应使用常量
  'height': 75.0,  // 应使用常量
};
```

---

## 📚 相关资源

- [示例代码](../example/lib/type_safe_adapter_example.dart)
- [API文档](./API文档.md)
- [更新日志](../CHANGELOG.md)
- [问题反馈](https://github.com/your-repo/issues)

---

*最后更新: 2024-07-12 - 架构重构，统一数据模型，简化使用方式*
